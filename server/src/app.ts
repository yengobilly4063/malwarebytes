import express, { Application } from "express";
import { Connection, createConnection } from "typeorm";
import dbConnectonOptions from "./db/config";
import "reflect-metadata";
import * as _env from "./config/index";
import cors from "cors";
import { buildSchema } from "type-graphql";
import { ApolloServer } from "apollo-server-express";
import { Container } from "typedi";
import {
  ApolloServerPluginLandingPageGraphQLPlayground,
  ApolloServerPluginLandingPageProductionDefault,
} from "apollo-server-core";
import { resolvers } from "./graphql/resolvers";
import { Context } from "./graphql/types";
import { setContextUser } from "./utils/auth.utils";
import authChecker from "./graphql/middlewares/auth.graphql";

const PORT = _env.NODE_ENV === "production" ? _env.PORT : 3005;

const main = async () => {
  try {
    const schema = await buildSchema({
      resolvers,
      authChecker,
      container: Container,
    });

    const app: Application = express();
    app.use(express.json());
    app.use(cors({ origin: _env.FRONTEND_URL, credentials: true }));

    const apolloServer = new ApolloServer({
      schema,
      context: async (context: Context) => {
        context = await setContextUser(context);
        return context;
      },
      plugins: [
        _env.NODE_ENV === "development"
          ? ApolloServerPluginLandingPageGraphQLPlayground
          : ApolloServerPluginLandingPageProductionDefault,
      ],
    });

    const connection: Connection = await createConnection(dbConnectonOptions);
    console.log(`Connection to ${connection.driver.database} database established`);

    await apolloServer.start();

    apolloServer.applyMiddleware({ app, path: _env.GRAPHQL_PATH });

    app.listen({ port: PORT }, () => {
      console.log(`server running on http://localhost:${PORT}${_env.GRAPHQL_PATH}`);
    });
  } catch (error) {
    console.error(`Unable to connect to ${dbConnectonOptions.database} database`);
  }
};

main();
